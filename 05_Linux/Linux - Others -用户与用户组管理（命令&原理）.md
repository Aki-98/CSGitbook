# 命令

## 用户管理

### useradd 添加用户

| 选项 | 说明                                                         |
| ---- | ------------------------------------------------------------ |
| -d   | 指定用户登入时的目录（主目录），如果此目录不存在，则同时使用-m选项，可以创建此目录 |
| -c   | 指定账户的备注文字                                           |
| -e   | 指定账号的有效期限                                           |
| -f   | 缓冲天数．密码过期时在指定天数后关闭该账号                   |
| -g   | 指定用户所属组                                               |
| -G   | 指定用户所属的附加用户组                                     |
| -m   | 自动建立用户的登入目录                                       |
| -r   | 创建系统账号                                                 |
| -s   | 指定用户的登陆shell                                          |
| -u   | 指定用户的用户ID。若添加-o选项、则ID可与其它用户重复         |

1-499为系统用户IP，用户IP应取500-60000之间的数值

可通过自看/etc/passwd文件，查看已存在的用户

创建账号的用户需有创建账号的权限

```
# 新建一个用户gem，该用户的登录Shell是/bin/sh，它属于group用户组，同时又属于adm和root用户组，其中group用户组是其主组
# 这里可能新建组group或adm
useradd -s /bin/sh -g group -G adm,root gem
```

增加用户账号就是在/etc/passwd用户中为新用户增加一条记录，同时更新其它系统文件如/etc/shadow/、/etc/group等

Linux提供了集成的系统管理工具userconf，它可以用来对用户账号进行统一管理

### passwd 设置用户的认证信息

包括用户密码，密码有效期等

用户账号刚创建时没有口令，但是被系统锁定，无法使用，必须为其指定口令后才可以使用，即使是指定空口令

| 选项 | 说明                                                     |
| ---- | -------------------------------------------------------- |
| -l   | 锁定密码，锁定后密码失效，无法登陆（新用户默认锁定）     |
| -d   | 删除密码．仅系统管理员可使用（指定空口令，不会锁定账号） |
| -S   | 列出密码相关信息，仅系统管理员可使用                     |
| -f   | 强迫用户下次登录时修改口令                               |
| -u   | 口令解锁                                                 |

root用户可随意更改自己和其它用户的密码，不需要知道原口令，即便出现警告，也可成功保存

普通用户设置新口令需要知道原口令

修改当前登录账户的密码时，可缺省用户名

用户密码保存在/etc/shadow文件中



### userdel 删除指定账户和账户相关的文件和信息

| 选项 | 说明                                     |
| ---- | ---------------------------------------- |
| -f   | 强制删除用户，即便该用户为当前用户       |
| -r   | 删除用户的同时，删除与用户相关的所有文件 |

删除用户账号就是将/etc/passwd等系统文件中的该用户记录删除，必要时删除用户的主目录

```
# 此命令删除用户sam在系统文件中（主要是/etc/passwd、/etc/shadow、/etc/group等）的记录，同时删除用户的主目录
userdel -r sam
```



### usdermod 修改用户账号信息

| 选项 | 说明                                         |
| ---- | -------------------------------------------- |
| -c   | 修改用户账号的备注信息                       |
| -d   | 修改用户的登入目录                           |
| -e   | 修改账号的有效期限                           |
| -f   | 修改缓冲天数，即修改密码过期后关闭账号的时间 |
| -g   | 修改用户所属组                               |
| -l   | 修改用户账号名称                             |
| -L   | 锁定用户密码，使密码失效                     |
| -s   | 修改用户登陆后使用的shell                    |
| -u   | 修改用户ID                                   |
| -U   | 解除密码锁定                                 |

举例：

```
#此命令将用户sam的登录Shell修改为ksh，主目录改为/home/z，用户组改为developer
usermod -s /bin/ksh -d /home/z -g developer sam
```



## 用户组管理

若用户被创建时没有指定用户组，系统会为用户创建一个与用户名相同的组，并将与该账号同名的用户组同步到/etc/group文件中，这个组就是基本组，若在某个用户的目录中创建文件。文件的所属组，就是用户的基本组；另外可以为用户指定附加组，除基本组之外，用户所在的组都是附加组。为用户指定附加组，可以使用户拥有对应组的权限。

对用户组的添加、删除、修改，本质上就是对/etc/group文件的更新。

相关：Linux.md > 与用户账号有关的系统文件

### groupadd 新增用户组

| 选项 | 说明                                                         |
| ---- | ------------------------------------------------------------ |
| -g   | 指定新建用户组的组ID                                         |
| -r   | 创建系统用户组，组ID取值范围为1-499                          |
| -o   | 一般与-g选项同时使用，表示新用户组的GID可以与系统已有的用户组的GID相同 |

添加一个新组，不指定组ID时，新组的组ID就是在当前已有的最大组标识号的基础上+1

### groupdel 删除用户组

### groupmod 修改用户组属性

| 选项 | 说明                                                         |
| ---- | ------------------------------------------------------------ |
| -g   | 位用户组指定新的组标识号                                     |
| -n   | 将用户组的名字改为新名字                                     |
| -o   | 一般与-g选项同时使用，表示新用户组的GID可以与系统已有的用户组的GID相同 |



### newgrp 切換用户组

如果一个用户同时属于多个用户组，那么用户可以在用户组之前切换，以便拒用其他用户组的权限。



# 与用户账号有关的系统文件

所有关于用户与用户组管理的命令本质上都是对有关系统文件进行的修改。

有关的系统文件：/etc/passwd、/etc/shadow、/etc/group

## /etc/passwd

内容类似：

![image-20230331134910098](Linux - Others -用户与用户组管理（命令&原理）_imgs\image-20230331134910098.png)

![image-20230331134942011](Linux - Others -用户与用户组管理（命令&原理）_imgs\image-20230331134942011.png)

每一行记录对应着一个用户，每行记录又被冒号:分隔为7个字段，其格式和具体含义如下：

```
用户名:口令:用户标识号:组标识号:注释性描述:主目录:登录Shell
```

- "用户名"是代表用户账号的字符串。

  - 通常长度不超过8个字符,并且由大小写字母和下或数字组成。登录名不能有冒号(:),因为冒号在这里是分隔符。
  - 为了兼容起见。登录名中最好不要包含点字符(.),并且不使用连字符(-)和加号(+)打头。

- “口令，一些系统中，存放着加密后的用户口令字。

  - 虽个字段存放的只是用户口令的加密串，不是明文，但是由于\etc\passwd文件对所有用户都可读，所以这仍是一个安全隐患。因此，现在许多Linux系统（如SVR4)都使用了shadow技术，把真正的加密后的用户口令字存放到/etc/shadow文件中，而在/etc/passwd文件的口令字段中只存放一个特殊的字符如"x"或者"*"

- “用户标识号"是一个整数，系统内部用它来标识用户。

  - 一般情况下它与用户名是一一对应的．如果几个用户名对应的用户标识号是一样的，系统内部将把它们视为同一个用户，但是它们可以有不同的口令、不同的主目录以及不同的登录Shell等．
  - 通常用户标识号的取值范围是0-65535。0是超级用户root的标识号，1-99由系统保留，作为管理账号，普通用户的标识号从100开始。在Linux系统中，这个界限是500

- “组标识号'，字段记录的是用户所属的用户组。

  - 它对应着/etc/group文件中的一条记录．

- “注释性描述”字段记录着用户的一些个人情况。

  - 例如用户的真实姓名、电话、地址等。这个字段并没有什么实际的用途．在不同的Linux系统中。这个字段的格式并没有统一，在许多Linux系统中。这个字段存放的是一段任意的注释性描述文字，用做finger命令的输出．

- “主目录”，也就是用户的起始工作目录。

  - 它是用户在登录到系统之后所处的目录．在大多数系统中。各用户的主目录都被组织在同一个持定的目录下，而用户主目录的名称就是该用户的登录名。各用户对自己的主目录有读、写、执行（搜索）权限，其他用户对此目录的访问权限则根据具体情况设置

- 用户登录后，要启动一个进程，负责将用户的操作传给内核，这个进程是用户登录到系统后运行的命令解释器或某个特定的程序，即Shell.

  - Shell是用户与Linux系统之间的接口。Linux的Shell有许多种，每种都有不同的持点。常用的有sh(BourneShell),csh(CShell),ksh(KornShell)，tcsh(TENEX/TOPS20 type C Shell),bash(BourneAgainShell)等·
  - 系统管理员可以根据系统情况和用户习惯为用户指定某个Shell.如果不指定Shell,那么系统使用sh为默认的登录Shell。即这个字段的值为/bin/sh。

  - 用户的登录Shell也可以指定为某个特定的程序（此程序不是一个命令解器）·
  - 利用这一特点。我们可以限制用户只能运行指定的应用程序。在该应程序运行继束后，用户就自动退出了系统。有些Linux系统要求只有那些在系统中登记了的程序才能出现在这个字段中·

## /etc/shadow

内容类似：

![image-20230331151723788](Linux - Others -用户与用户组管理（命令&原理）_imgs\image-20230331151723788.png)

![image-20230331151733789](Linux - Others -用户与用户组管理（命令&原理）_imgs\image-20230331151733789.png)

/etc/shadow中的记录行与/etc/passwd中的一一对应，它由pwconv命令根据etc/passwd中的数据自动产生

它的文件格式与/etc/passwd类似，由若干个字段绢成，字段之间用:隔开。这些字段是：

```
登录名：加密口令：最后一次修改时间：最小时间间隔：最大时间间隔：警告时间：不活动时间：失效时间：标志
```

- “登录名是与/etc/passwd文件中的登录名相一致的用户账号
- “囗令"字段存放的是加密后的用户囗令字，长度为13个字符．如果为空，则对应户没有口令，登录时不需要囗令；如果含有不属于集合{./0-9A-Za-z}中的字符，则对应的用户不能登录
- “最后一次修改时间“表示的是从某个时刻起，到用户最后一次修改口令时的天数．时间起点对不同的系统可能不一样．例如在SCO Linux中，这个时间起点是1970年1月1日．
- "最小时间间隔"指的是两次修改囗令之间所需的最小天数。
- “最大时间间隔"指的是囗令保持有效的最大天数。
- "警告时间"字段表示地时从系统开始警告用户到用户密码正式失效之间的天数
- "不活动时间"表示的时用户没有登录活动但账号仍能保持有效的最大天数
- "失效时间"字段给出的是一个绝对的天数，如果使用了这个字段，那么就给出相应账号的生存期。期满后，该账号就不再是一个合法的账号，也就不能再用来登陆了。

## /etc/group

内容例子：

![image-20230331152335470](Linux - Others -用户与用户组管理（命令&原理）_imgs\image-20230331152335470.png)

放置用户组的所有信息

将用户分组是Linux系统中对用户进行管理及控制访问仅限的一种手段。

每个用户都属于某个用户组；一个组中可以有多个用户。一个用户也可以属于不同的组。

当一个用户同时是多个组中的成员时。在/etc/passwd文件中记录的是用户所属的主组，也就是登录所属的默认组,而真他组称为附加组。

用户要访问属于附加组的文件时，必须首先使用newgrp命令使自己成为所要访问的组中的成员。

用户组的所有信息都存放在/etc/group文件中。此文件的格式也类似于/etc/passwd文件，由冒号(:)隔开若干个字段．这些字段有：

```
组名：口令：组标识号：组内用户列表
```

- "组名"是用户组的名称，由字母或数字构成。与/etc/passwd中的登录名一样，组名不应重复。
- "口令"字段存放的是用户组加密后的口令字。—般Linux系统的用户组都没有口令，即这个字段一般为空，或者是*
- "组标识号"与用户标识号类似，也是一个整数，被系统内部用来标识组
- "组内用户列表"是属于这个组的所有用户的列表/b,不同用户之间用逗号(,)分隔。这个用户组可能是用户的主组，也可能是夫家族

# 伪用户

系统中有一类用户称为伪用户(pseudo users)。

- 这些用户在/etc/passwd文件中也占有一条记录。但是不能登录。因为它们的登录Shell为空。它们的存在主要是方便系统管理，满足相应的系统进程对文件属主的要求·
- 常见的伪用户如下所示：

| 伪用户 | 含义                     |
| ------ | ------------------------ |
| bin    | 拥有可执行的用户命令文件 |
| sys    | 拥有系统文件             |
| adm    | 拥有帐户文件             |
| uucp   | UUCP使用                 |
| lp     | lp或lpd子系统使用        |
| nobody | NPS使用                  |

**除了上面列出的伪用户外，还有许多标准的伪用户例如：audit,cron,mail,usenet等，它们也都各自为相关的进程和文件所需要。**

由于/etc/passwd文件是所有用户都可读的，如果用户的密码太筒单或规律比较明显的i话，一台普通的计算机很容易地将它破解，因此对安全性要求较高的Linux系统都把加密后的口令字分离出来，单独存放在一个文件中，这个文件是etc/shadow文件。超级用户才拥有该文件读权限，这就保证了用户密码的安全性。

# 添加批量用户

添加和删除用户对每应Linux系统管理员都是轻而易举的事，比较棘手的是如果要添加几十个．上百个甚至上千个用户时，我们不太可能还使用useradd一个一个地添加。必然要找一种简便的创建大量户的方法．Linnux系统提供了创建大量用户的工具，可以让您立即创建大量用户，方法如下

**(1)先编辑一个文本用户文件。**

每一列按照/etc/passwd密码文件的格式书写，要注意每个用户的用户名、UID、宿主目录都不可以相同，其中密码栏可以留做空白或输入x号，一个范例文件user.txt内容如下：

![image-20230331153336509](Linux - Others -用户与用户组管理（命令&原理）_imgs\image-20230331153336509.png)

![image-20230331153345226](Linux - Others -用户与用户组管理（命令&原理）_imgs\image-20230331153345226.png)

**(2)以root身份执行命令/usr/sbin/newusers,从刚创建的用户文件user.txt中导入数据.创建用户：**

```
newusers < user.txt
```

然后可以执行命令vipw或vi/etc/passwd检查/etc/passwd文件是否已经出现这些用户的数据，并且用户的宿主目录是否已经创建。

**(3)执行命令/usr/sbin/pwunconv**

将/etc/shadow产生的shadow密码解锁，然后回写道/etc/passwd中，并将/etc/shadow的shadow密码栏删掉，这是为了方便下一步的密码转换工作，即先取消shadow password功能

**(4)编辑毎个用户的密码对照文件**

范例文件passwd.txt内容如下：

![image-20230331153839387](Linux - Others -用户与用户组管理（命令&原理）_imgs\image-20230331153839387.png)

**(5)以root身份执行命令/usr/sbin/chpasswd**

创建用户密码，chpasswd会将经过/usr/bin/passwd命令编码过的密码写入/etc/passwd的密码栏

```
chpasswd < passwd.txt
```

(6)确定密码经编码写入/etc/passwd的密码栏后

执行命令/usr/sbin/pwconv将密码编码为shadow password，并将结果写入/etc/shadow

```
pwconv
```

这样就完成了大量用户的创建了，之后您可以到/home下检查这些用户宿主目录的权限设置是否都正确，并登录验证用户密码是否正确。