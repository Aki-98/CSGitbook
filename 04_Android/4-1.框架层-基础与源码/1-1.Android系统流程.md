# Android系统启动的流程

![image-20231204170320731](E:\.personal\CSGitbook\04_Android\4-1.框架层-基础与源码\1-1 Android系统流程_imgs\image-20231204170320731.png)

Step1：启动电源及系统启动

当电源按下，引导芯片代码开始从预定义的地方（固化在ROM）开始执行。加载引导程序到RAM，然后执行。

Step2：引导程序

引导程序是在Android操作系统开始运行前的一个小程序。引导程序是运行的第一个程序，因此它是针对特定的主板与芯片的。设备制造商要么使用很受欢迎的引导程序比如redboot、uboot、qibootloader或者开发自己的引导程序，它不是Android操作系统的一部分。引导程序是OEM厂商或者运营商加锁和限制的地方。

引导程序分两个阶段执行：

第一个阶段，检测外部的RAM以及加载对第二阶段有用的程序；

第二个阶段，引导程序设置网络、内存等等。这些对于运行内核是必要的，为了达到特殊的目标，引导程序可以根据配置参数或者输入数据设置内核。

Android引导程序可以在\bootable\bootloader\legacy\usbloader找到。传统的加载器包含两个文件，需要在这里说明：

init.s初始化堆栈，清零BBS段，调用main.c的_main()函数；

> **初始化堆栈**：在系统启动时，处理器需要有一个堆栈来执行函数调用。`init.s`中的代码会在开始时设置处理器的堆栈指针，以确保后续的代码有足够的栈空间进行正常操作。
>
> **清零BSS段**：BSS段是用于存储未初始化的全局变量的内存区域。清零BSS段确保所有变量在首次使用之前为零，避免残留的数据导致意外行为。
>
> **调用_main()函数**：完成初始化后，`init.s`会调用`main.c`文件中的`_main()`函数，这样可以将控制权传递给更高级别的启动逻辑。

main.c初始化硬件（闹钟、主板、键盘、控制台），创建Linux标签

> **初始化硬件**：`main.c`文件主要负责设备的硬件初始化，包括设置关键的外设和子系统。
>
> - **闹钟**：初始化时钟模块，使系统拥有一个基本的计时功能，保证各模块能够正确同步。
> - **主板**：初始化主板上的关键部件，以保证基本硬件可以被正确识别和使用。
> - **键盘**：如果系统有键盘设备，在这里进行初始化，以便后续用户交互。
> - **控制台**：初始化控制台，通常是串口或显示输出，用于显示调试信息或者状态信息。
>
> **创建Linux标签**：在启动完成硬件初始化后，`main.c`会创建Linux标签（boot tags）。这些标签包含了启动内核所需的关键信息，比如内存布局、根文件系统位置等。标签通常被传递给Linux内核，以便内核可以正确解析系统状态并完成启动过程。

Step3：内核

Android内核与桌面Linux内核的启动方式差不多。内核启动时，设置缓存、被保护存储器、计划列表，加载驱动。当内核完成系统设置，它首先在系统文件中寻找“init”文件，然后启动root进程或者系统的第一个进程

Step4：init进程

init进程时Linux系统中用户空间的第一个进程，进程号固定为1。Kernel启动后，在用户空间启动init进程，并调用init中的main() 方法执行init进程的职责。

Step5：启动Launcher App